<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gest√£o de Clientes & Assinaturas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos Globais -->
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbar Personalizada */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        
        /* Safe Area para iPhones recentes */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Estilos de Impress√£o */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        }

        /* Anima√ß√µes */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-scaleIn { animation: scaleIn 0.2s ease-out; }
        
        @keyframes spin-slow { to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 3s linear infinite; }
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom"
      }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Users, DollarSign, Calendar, Save, FileText, Copy, Check, 
            Download, Link as LinkIcon, Settings, TrendingUp, Sparkles, Edit, X, 
            AlertTriangle, Search, Filter, ArrowUpDown, ArrowUp, ArrowDown, 
            PieChart as PieIcon, BarChart3, List, RefreshCw, MessageCircle, 
            CreditCard, Clock, AlertCircle, Lock, LogIn, LogOut, ShieldCheck, 
            UserPlus, Database, DownloadCloud, Printer, FileCheck, Package, History, ChevronRight, Menu 
        } from 'lucide-react';
        import { 
            LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, 
            Tooltip as RechartsTooltip, Legend, ResponsiveContainer, AreaChart, 
            Area, PieChart, Pie, Cell 
        } from 'recharts';

        // --- FIREBASE IMPORTS ---
        import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, signOut, signInWithCustomToken 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, 
            doc, onSnapshot, query, where, getDocs 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- CONFIGURA√á√ÉO ---
        const userProvidedConfig = {
            apiKey: "AIzaSyDffZeLH_VxYM8WpiCgN233tqFzyeyrBd4",
            authDomain: "gerenciadordeclientes-25c9a.firebaseapp.com",
            projectId: "gerenciadordeclientes-25c9a",
            storageBucket: "gerenciadordeclientes-25c9a.firebasestorage.app",
            messagingSenderId: "780160513842",
            appId: "1:780160513842:web:1c1b60cca7630ae040492b"
        };

        const getFirebaseConfig = () => {
            try {
                const localConfig = localStorage.getItem('custom_firebase_config');
                if (localConfig) return JSON.parse(localConfig);
                return userProvidedConfig;
            } catch (e) {
                return userProvidedConfig;
            }
        };

        const initFirebase = () => {
            const config = getFirebaseConfig();
            if (!config) return { app: null, auth: null, db: null };
            try {
                const app = getApps().length === 0 ? initializeApp(config) : getApp();
                return { app, auth: getAuth(app), db: getFirestore(app) };
            } catch (e) {
                console.error("Erro Init Firebase", e);
                return { app: null, auth: null, db: null };
            }
        };

        const { auth, db } = initFirebase();
        const appId = 'client-manager-app'; 

        const getCollectionPath = (uid, collectionName = 'clients') => {
            return `users/${uid}/${collectionName}`;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [authError, setAuthError] = useState('');

            const [activeTab, setActiveTab] = useState('management');
            const [showConfig, setShowConfig] = useState(false);
            const [customConfig, setCustomConfig] = useState(userProvidedConfig);
            const [isEditingConfig, setIsEditingConfig] = useState(false);
            const [webAppUrl, setWebAppUrl] = useState(() => {
                try { return localStorage.getItem('sheet_webhook_url') || ''; } catch { return ''; }
            });
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncStatus, setSyncStatus] = useState('');

            const [clients, setClients] = useState([]);
            const [plans, setPlans] = useState([]);

            const initialClientState = {
                name: '', whatsapp: '', service: '', planId: '', type: 'Mensal', value: '',
                paymentMethod: 'Pix', dueDay: '', date: new Date().toISOString().split('T')[0],
                status: 'Pendente', notes: '', history: []
            };
            const initialPlanState = { name: '', value: '', description: '' };

            const [newClient, setNewClient] = useState(initialClientState);
            const [newPlan, setNewPlan] = useState(initialPlanState);

            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('Todos');
            const [filterStatus, setFilterStatus] = useState('Todos');
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });

            const [editingClient, setEditingClient] = useState(null);
            const [receiptClient, setReceiptClient] = useState(null);
            const [historyClient, setHistoryClient] = useState(null);
            const [deletingId, setDeletingId] = useState(null);
            const [showRenewalModal, setShowRenewalModal] = useState(false);
            const [pendingRenewals, setPendingRenewals] = useState([]);

            // --- EFFECTS ---
            useEffect(() => {
                const savedConfig = localStorage.getItem('custom_firebase_config');
                if (savedConfig) setCustomConfig(JSON.parse(savedConfig));
            }, []);

            useEffect(() => {
                if (!auth) { setAuthLoading(false); return; }
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setAuthLoading(false);
                    if (currentUser) { setPassword(''); setAuthError(''); }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) { setClients([]); setPlans([]); return; }
                const clientsUnsub = onSnapshot(query(collection(db, getCollectionPath(user.uid, 'clients'))), (snapshot) => {
                    const clientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setClients(clientsData);
                });
                const plansUnsub = onSnapshot(query(collection(db, getCollectionPath(user.uid, 'plans'))), (snapshot) => {
                    const plansData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPlans(plansData);
                });
                return () => { clientsUnsub(); plansUnsub(); };
            }, [user]);

            useEffect(() => {
                try { localStorage.setItem('sheet_webhook_url', webAppUrl); } catch (e) {}
            }, [webAppUrl]);

            // --- HELPERS ---
            const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(val) || 0);
            
            const isOverdue = (c) => {
                if (c.status === 'Pago' || c.status === 'Conclu√≠do') return false;
                const today = new Date(); today.setHours(0,0,0,0);
                if (!c.date) return false;
                const clientDate = new Date(c.date);
                return clientDate < today;
            };

            // --- HANDLERS ---
            const handleAuth = async (e) => {
                e.preventDefault();
                if (!auth) { setAuthError("Erro config Firebase."); return; }
                setAuthError(''); setAuthLoading(true);
                try {
                    if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) { setAuthError("Erro de autentica√ß√£o."); } finally { setAuthLoading(false); }
            };
            const handleLogout = async () => { if (auth) await signOut(auth); setActiveTab('management'); };

            const handleAddPlan = async (e) => {
                e.preventDefault(); if (!newPlan.name || !newPlan.value || !user) return; setIsSyncing(true);
                try { await addDoc(collection(db, getCollectionPath(user.uid, 'plans')), { ...newPlan, value: Number(newPlan.value) }); setNewPlan(initialPlanState); } catch (e) { console.error(e); } finally { setIsSyncing(false); }
            };
            const handleDeletePlan = async (id) => { if(!confirm("Excluir este plano?")) return; try { await deleteDoc(doc(db, getCollectionPath(user.uid, 'plans'), id)); } catch(e) { console.error(e); } };

            const handleAddClient = async (e) => {
                e.preventDefault(); if (!newClient.name || !newClient.value || !user) return; setIsSyncing(true);
                try { const clientData = { ...newClient, value: Number(newClient.value) }; await addDoc(collection(db, getCollectionPath(user.uid, 'clients')), clientData); setNewClient(initialClientState); } catch (error) { console.error(error); alert("Erro ao salvar."); } finally { setIsSyncing(false); }
            };
            const handleUpdateClient = async (e) => {
                e.preventDefault(); if (!editingClient || !user) return; setIsSyncing(true);
                try { const { id, ...data } = editingClient; await updateDoc(doc(db, getCollectionPath(user.uid, 'clients'), id), { ...data, value: Number(data.value) }); setEditingClient(null); } catch (error) { console.error(error); } finally { setIsSyncing(false); }
            };
            const executeDelete = async () => { if (!deletingId || !user) return; setIsSyncing(true); try { await deleteDoc(doc(db, getCollectionPath(user.uid, 'clients'), deletingId)); setDeletingId(null); } catch (e) { console.error(e); } finally { setIsSyncing(false); } };

            const handleConfirmPayment = async (client) => {
                if (!user || !confirm(`Confirmar pagamento de ${formatCurrency(client.value)} para ${client.name}?`)) return;
                const paymentRecord = { date: new Date().toISOString(), amount: client.value, status: 'Pago', method: client.paymentMethod, refDate: client.date };
                const updatedHistory = [...(client.history || []), paymentRecord];
                try { await updateDoc(doc(db, getCollectionPath(user.uid, 'clients'), client.id), { status: 'Pago', history: updatedHistory }); if (historyClient && historyClient.id === client.id) { setHistoryClient({ ...client, status: 'Pago', history: updatedHistory }); } } catch (e) { console.error(e); }
            };

            const handlePrintReport = () => window.print();
            const handlePrintReceipt = () => {
                const printContent = document.getElementById('receipt-area');
                if (printContent) { const originalContents = document.body.innerHTML; document.body.innerHTML = printContent.innerHTML; window.print(); document.body.innerHTML = originalContents; window.location.reload(); }
            };

            const handleSyncFromSheets = async () => {
                if (!webAppUrl) { alert("Configure a URL do Web App primeiro."); return; }
                if (!user || !db || !confirm("Isso ir√° ler os dados da planilha. Continuar?")) return;
                setIsSyncing(true);
                try {
                    const response = await fetch(webAppUrl); if (!response.ok) throw new Error('Falha ao conectar');
                    const sheetData = await response.json();
                    const path = getCollectionPath(user.uid, 'clients'); const colRef = collection(db, path); const snap = await getDocs(colRef); const current = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    for (const row of sheetData) {
                        const exists = current.find(c => c.name.toLowerCase() === row.name.toLowerCase() && c.date === row.date);
                        const payload = { name: row.name, whatsapp: row.whatsapp||'', service: row.service||'', type: row.type||'Mensal', value: Number(row.value)||0, paymentMethod: row.paymentMethod||'', dueDay: row.dueDay||'', date: row.date ? new Date(row.date).toISOString().split('T')[0] : '', status: row.status||'Pendente', notes: row.notes||'' };
                        if(exists) await updateDoc(doc(db, path, exists.id), payload); else await addDoc(colRef, payload);
                    }
                    alert("Sincroniza√ß√£o conclu√≠da!");
                } catch (e) { alert("Erro ao sincronizar: " + e.message); } finally { setIsSyncing(false); }
            };

            const checkRenewals = () => {
                const today = new Date(); const currentMonth = today.getMonth(); const currentYear = today.getFullYear(); const suggestions = []; const clientsByName = {};
                clients.forEach(client => { if (!clientsByName[client.name] || new Date(client.date) > new Date(clientsByName[client.name].date)) { clientsByName[client.name] = client; } });
                Object.values(clientsByName).forEach(client => {
                    if (client.type === 'Mensal' && client.status !== 'Conclu√≠do') {
                        const clientDate = new Date(client.date);
                        if (clientDate.getMonth() !== currentMonth || clientDate.getFullYear() !== currentYear) {
                            let renewalDate = today; if (client.dueDay) { renewalDate = new Date(today.getFullYear(), today.getMonth(), parseInt(client.dueDay)); }
                            suggestions.push({ ...client, newDate: renewalDate.toISOString().split('T')[0], status: 'Pendente', originalId: client.id });
                        }
                    }
                });
                setPendingRenewals(suggestions); setShowRenewalModal(true);
            };

            const executeRenewals = async () => {
                if (!user || !db) return; setIsSyncing(true); let count = 0; const path = getCollectionPath(user.uid, 'clients');
                for (const item of pendingRenewals) {
                    const newEntry = { name: item.name, whatsapp: item.whatsapp || '', service: item.service || '', type: 'Mensal', value: Number(item.value), paymentMethod: item.paymentMethod || '', dueDay: item.dueDay || '', date: item.newDate, status: 'Pendente', notes: item.notes || '' };
                    try { await addDoc(collection(db, path), newEntry); count++; if (webAppUrl) { await fetch(webAppUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newEntry) }); } } catch (e) { console.error(e); }
                }
                setIsSyncing(false); setShowRenewalModal(false); alert(`${count} renovados!`);
            };

            const downloadCSV = () => {
                const headers = ['Nome,Plano,Valor,Data,Status'];
                const rows = processedClients.map(c => `"${c.name}","${c.service}","${c.value}","${c.date}","${c.status}"`);
                const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "assinantes.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const processedClients = useMemo(() => {
                let result = clients.filter(c => {
                    const matchesSearch = c.name.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesType = filterType === 'Todos' || c.type === filterType;
                    const matchesStatus = filterStatus === 'Todos' || c.status === filterStatus;
                    return matchesSearch && matchesType && matchesStatus;
                });
                if (sortConfig.key) {
                    result.sort((a, b) => {
                        let valA = a[sortConfig.key] || '', valB = b[sortConfig.key] || '';
                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();
                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return result;
            }, [clients, searchTerm, filterType, filterStatus, sortConfig]);

            const chartData = useMemo(() => {
                const grouped = {};
                const sorted = [...clients].sort((a, b) => new Date(a.date) - new Date(b.date));
                sorted.forEach(c => {
                    const key = new Date(c.date).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    if (!grouped[key]) grouped[key] = { name: key, Mensal: 0, Fixo: 0, Total: 0 };
                    if (c.type === 'Mensal') grouped[key].Mensal += Number(c.value); else grouped[key].Fixo += Number(c.value);
                    grouped[key].Total += Number(c.value);
                });
                return Object.values(grouped);
            }, [clients]);

            const planDistribution = useMemo(() => {
                const dist = {};
                clients.filter(c => c.type === 'Mensal').forEach(c => {
                    const planName = plans.find(p => p.id === c.planId)?.name || c.service || 'Outros';
                    dist[planName] = (dist[planName] || 0) + 1;
                });
                return Object.keys(dist).map(name => ({ name, value: dist[name] }));
            }, [clients, plans]);

            const COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

            const SortableHeader = ({ label, sortKey, align = 'left' }) => (
                <th className={`p-4 md:p-5 ${align === 'right' ? 'text-right' : 'text-left'} cursor-pointer hover:bg-slate-100 transition-colors select-none`} onClick={() => {
                    let direction = 'asc'; if (sortConfig.key === sortKey && sortConfig.direction === 'asc') direction = 'desc'; setSortConfig({ key: sortKey, direction });
                }}>
                    <div className={`flex items-center gap-1 ${align === 'right' ? 'justify-end' : 'justify-start'}`}>
                        {label} <span className="text-slate-400">{sortConfig.key === sortKey ? (sortConfig.direction === 'asc' ? <ArrowUp size={12} /> : <ArrowDown size={12} />) : <ArrowUpDown size={12} className="opacity-0 md:opacity-50" />}</span>
                    </div>
                </th>
            );

            const ClientForm = ({ data, setData, onSubmit, isEditing = false }) => (
                <form onSubmit={onSubmit} className="space-y-4">
                    <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nome do Cliente</label><input type="text" required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" value={data.name} onChange={(e) => setData({...data, name: e.target.value})} /></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Plano Contratado</label><select className="w-full p-3 bg-indigo-50 border border-indigo-200 text-indigo-900 rounded-xl outline-none cursor-pointer font-medium" value={data.planId} onChange={(e) => { const selectedPlan = plans.find(p => p.id === e.target.value); setData({ ...data, planId: e.target.value, service: selectedPlan ? selectedPlan.name : '', value: selectedPlan ? selectedPlan.value : '' }); }}><option value="">Selecione um Plano...</option>{plans.map(p => <option key={p.id} value={p.id}>{p.name} - {formatCurrency(p.value)}</option>)}<option value="custom">Personalizado (Manual)</option></select></div>
                    {!data.planId || data.planId === 'custom' ? ( <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Servi√ßo</label><input type="text" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" value={data.service} onChange={(e) => setData({...data, service: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Valor</label><input type="number" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" value={data.value} onChange={(e) => setData({...data, value: e.target.value})} /></div></div> ) : ( <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 text-sm text-indigo-800 flex justify-between items-center"><span>Valor do Plano:</span><span className="font-bold text-lg">{formatCurrency(data.value)}</span></div> )}
                    <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Vencimento</label><input type="number" min="1" max="31" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="Dia" value={data.dueDay} onChange={(e) => setData({...data, dueDay: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Data In√≠cio</label><input type="date" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" value={data.date} onChange={(e) => setData({...data, date: e.target.value})} /></div></div>
                    {isEditing && ( <div className="mt-4"><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Status</label><select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" value={data.status} onChange={(e) => setData({...data, status: e.target.value})}><option value="Pendente">Pendente</option><option value="Pago">Pago</option><option value="Em atraso">Atrasado</option><option value="Conclu√≠do">Conclu√≠do</option></select></div> )}
                    <button type="submit" disabled={isSyncing} className="w-full py-4 rounded-xl font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg transition-all flex justify-center items-center gap-2">{isSyncing ? 'Salvando...' : <><Check size={20} /> {isEditing ? 'Atualizar' : 'Cadastrar'}</>}</button>
                </form>
            );

            const AppsScriptView = () => {
                const [copied, setCopied] = useState(false);
                const scriptCode = `function doGet(e){try{const s=SpreadsheetApp.getActiveSpreadsheet().getActiveSheet(),r=s.getDataRange().getValues(),d=[];for(let i=1;i<r.length;i++){d.push({name:r[i][0],whatsapp:r[i][1],service:r[i][2],type:r[i][3],value:r[i][4],paymentMethod:r[i][5],dueDay:r[i][6],date:r[i][7]?new Date(r[i][7]).toISOString().split('T')[0]:'',status:r[i][8],notes:r[i][9]})}return ContentService.createTextOutput(JSON.stringify(d)).setMimeType(ContentService.MimeType.JSON)}catch(e){return ContentService.createTextOutput(JSON.stringify({error:e.toString()})).setMimeType(ContentService.MimeType.JSON)}}function doPost(e){try{const s=SpreadsheetApp.getActiveSpreadsheet().getActiveSheet(),d=JSON.parse(e.postData.contents);s.appendRow([d.name,d.whatsapp||'',d.service||'',d.type,d.value,d.paymentMethod||'',d.dueDay||'',d.date,d.status,d.notes||'',new Date()]);s.getRange(s.getLastRow(),5).setNumberFormat('R$ #,##0.00');return ContentService.createTextOutput(JSON.stringify({result:'success'})).setMimeType(ContentService.MimeType.JSON)}catch(e){return ContentService.createTextOutput(JSON.stringify({error:e.toString()}))}}function onOpen(){SpreadsheetApp.getUi().createMenu('üí∞ Gest√£o').addItem('‚ûï Novo','adicionarCliente').addToUi()}`;
                const handleCopy = () => { const t = document.createElement("textarea"); t.value = scriptCode; t.style.position = "fixed"; t.style.left = "-9999px"; document.body.appendChild(t); t.focus(); t.select(); try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (e) {} document.body.removeChild(t); };
                return <div className="space-y-6 animate-fadeIn pb-24"><div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-100"><div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-4"><span className="ml-2 text-slate-400 font-bold text-sm">C√≥digo Compacto</span><button onClick={handleCopy} className={`flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium ${copied ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-600'}`}>{copied ? 'Copiado' : 'Copiar'}</button></div><pre className="overflow-x-auto whitespace-pre-wrap h-32 custom-scrollbar text-emerald-600 bg-slate-50 p-4 rounded-xl text-xs">{scriptCode}</pre></div></div>;
            };

            if (!user) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl animate-scaleIn">
                        <div className="flex justify-center mb-6"><div className="bg-indigo-100 p-4 rounded-full"><ShieldCheck className="text-indigo-600 w-10 h-10" /></div></div>
                        <h2 className="text-2xl font-extrabold text-center text-slate-800 mb-2">{isRegistering ? 'Criar Conta' : '√Årea do Parceiro'}</h2>
                        <form onSubmit={handleAuth} className="space-y-6">
                            <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Email</label><div className="relative"><div className="absolute left-3 top-3.5 text-slate-400"><Users size={18} /></div><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" required /></div></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Senha</label><div className="relative"><div className="absolute left-3 top-3.5 text-slate-400"><Lock size={18} /></div><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" required minLength={6} /></div>{authError && <p className="text-red-500 text-sm mt-2 flex items-center gap-1"><AlertCircle size={14} /> {authError}</p>}</div>
                            <button type="submit" disabled={authLoading} className={`w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition-all flex justify-center items-center gap-2 ${authLoading ? 'opacity-70' : ''}`}>{authLoading ? '...' : (isRegistering ? <UserPlus size={20} /> : <LogIn size={20} />)} {isRegistering ? 'Cadastrar' : 'Entrar'}</button>
                        </form>
                        <div className="mt-6 text-center"><button onClick={() => { setIsRegistering(!isRegistering); setAuthError(''); }} className="text-sm text-indigo-600 font-bold hover:underline">{isRegistering ? 'J√° tenho conta' : 'Criar conta nova'}</button></div>
                    </div>
                </div>
            );

            // PRINCIPAL
            return (
                <div className="min-h-screen bg-slate-50 pb-20 md:pb-12 relative">
                    {/* MOBILE BOTTOM NAV */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-50 flex justify-around items-center px-2 py-1 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <button onClick={() => setActiveTab('overview')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${activeTab === 'overview' ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}><BarChart3 size={20} /><span className="text-[10px] font-medium mt-1">Dash</span></button>
                        <button onClick={() => setActiveTab('plans')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${activeTab === 'plans' ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}><Package size={20} /><span className="text-[10px] font-medium mt-1">Planos</span></button>
                        <div className="relative -top-5"><button onClick={() => setActiveTab('management')} className="bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 transition-transform active:scale-95 border-4 border-slate-50"><Plus size={24} /></button></div>
                        <button onClick={() => setActiveTab('management')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${activeTab === 'management' ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}><Users size={20} /><span className="text-[10px] font-medium mt-1">Clientes</span></button>
                        <button onClick={() => setActiveTab('script')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${activeTab === 'script' ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}><Settings size={20} /><span className="text-[10px] font-medium mt-1">Config</span></button>
                    </div>

                    {/* MODALS */}
                    {receiptClient && (
                        <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-fadeIn">
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-md overflow-hidden relative">
                                <button onClick={() => setReceiptClient(null)} className="absolute top-2 right-2 p-2 text-slate-400 hover:text-slate-600 no-print"><X size={24} /></button>
                                <div id="receipt-area" className="p-6 md:p-8 border-4 border-double border-slate-200 m-4">
                                    <div className="text-center mb-6 border-b-2 border-slate-100 pb-4">
                                        <div className="flex justify-center mb-3 text-indigo-600"><Check size={48} className="border-4 border-indigo-100 rounded-full p-1" /></div>
                                        <h2 className="text-2xl font-bold text-slate-800 uppercase tracking-widest">Recibo</h2>
                                        <p className="text-slate-400 text-xs mt-1">{new Date().toLocaleDateString()} ‚Ä¢ #{receiptClient.id.toString().slice(-6)}</p>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="text-center">
                                            <p className="text-slate-500 text-sm uppercase font-bold tracking-wider">Valor Pago</p>
                                            <p className="text-4xl font-extrabold text-indigo-600 my-1">{formatCurrency(receiptClient.value)}</p>
                                        </div>
                                        <div className="bg-slate-50 p-4 rounded-xl space-y-2 text-sm border border-slate-100">
                                            <div className="flex justify-between"><span className="text-slate-500 font-bold">Cliente:</span><span className="text-slate-800 font-medium">{receiptClient.name}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500 font-bold">Servi√ßo:</span><span className="text-slate-800 font-medium">{receiptClient.service || 'Servi√ßos Gerais'}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500 font-bold">Data:</span><span className="text-slate-800 font-medium">{new Date(receiptClient.date).toLocaleDateString()}</span></div>
                                        </div>
                                    </div>
                                    <div className="mt-6 text-center border-t-2 border-slate-100 pt-4"><p className="text-slate-400 text-xs italic">Obrigado pela prefer√™ncia!</p></div>
                                </div>
                                <div className="bg-slate-50 p-4 flex justify-center no-print"><button onClick={handlePrintReceipt} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg flex items-center gap-2"><Printer size={18} /> Imprimir</button></div>
                            </div>
                        </div>
                    )}

                    {historyClient && (
                        <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-fadeIn">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-scaleIn flex flex-col max-h-[85vh]">
                                <div className="bg-indigo-600 p-4 md:p-6 flex justify-between items-center text-white shrink-0">
                                    <div><h3 className="font-bold text-lg md:text-xl flex items-center gap-2"><History size={20} /> Hist√≥rico</h3><p className="opacity-80 text-xs md:text-sm mt-1">{historyClient.name}</p></div>
                                    <button onClick={() => setHistoryClient(null)} className="hover:bg-indigo-500 p-2 rounded-full transition-colors"><X size={24}/></button>
                                </div>
                                <div className="p-4 md:p-6 overflow-y-auto custom-scrollbar grow">
                                    <div className="flex items-center justify-between mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <div><p className="text-xs text-slate-500 font-bold uppercase">Plano</p><p className="text-base md:text-lg font-bold text-indigo-700">{historyClient.service || plans.find(p=>p.id===historyClient.planId)?.name || 'Personalizado'}</p></div>
                                        <div className="text-right"><p className="text-xs text-slate-500 font-bold uppercase">Valor</p><p className="text-base md:text-lg font-bold text-slate-800">{formatCurrency(historyClient.value)}</p></div>
                                    </div>
                                    <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide"><List size={16} /> Extrato</h4>
                                    {(!historyClient.history || historyClient.history.length === 0) ? (
                                        <div className="text-center py-8 border-2 border-dashed border-slate-200 rounded-xl text-slate-400"><Clock size={32} className="mx-auto mb-2 opacity-50" /><p className="text-sm">Sem hist√≥rico.</p></div>
                                    ) : (
                                        <div className="space-y-3">
                                            {[...historyClient.history].reverse().map((record, idx) => (
                                                <div key={idx} className="flex justify-between items-center p-3 md:p-4 bg-white border border-slate-100 rounded-xl shadow-sm">
                                                    <div className="flex items-center gap-3"><div className="bg-green-100 p-2 rounded-full text-green-600"><Check size={14} /></div><div><p className="font-bold text-slate-700 text-sm">Pago</p><p className="text-[10px] text-slate-500">{new Date(record.date).toLocaleDateString('pt-BR')}</p></div></div>
                                                    <div className="text-right"><p className="font-bold text-green-600 text-sm">{formatCurrency(record.amount)}</p></div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {historyClient.status !== 'Pago' && ( <div className="p-4 border-t border-slate-100 bg-slate-50 shrink-0"><button onClick={() => handleConfirmPayment(historyClient)} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2"><Check size={20} /> Confirmar Pagamento</button></div> )}
                            </div>
                        </div>
                    )}

                    {editingClient && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fadeIn overflow-y-auto no-print">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-scaleIn my-4">
                                <div className="bg-indigo-600 p-4 flex justify-between items-center text-white sticky top-0 z-10"><h3 className="font-bold text-lg flex items-center gap-2"><Edit size={20} /> Editar</h3><button onClick={() => setEditingClient(null)} className="p-1 hover:bg-indigo-500 rounded-full"><X size={20} /></button></div>
                                <div className="p-6"><ClientForm data={editingClient} setData={setEditingClient} onSubmit={handleUpdateClient} isEditing={true} /></div>
                            </div>
                        </div>
                    )}

                    {/* HEADER DESKTOP */}
                    <div className="hidden md:block relative bg-gradient-to-r from-indigo-600 to-violet-600 text-white pb-32 rounded-b-[3rem] shadow-xl overflow-hidden no-print">
                        <div className="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <div className="max-w-7xl mx-auto px-6 pt-8 pb-6 relative z-10">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                                <div className="flex items-center gap-4">
                                    <div className="bg-white/20 p-3 rounded-2xl backdrop-blur-md shadow-inner"><Sparkles size={32} className="text-yellow-300" /></div>
                                    <div><h1 className="text-3xl font-extrabold tracking-tight">Gest√£o SaaS</h1><p className="text-indigo-100 font-medium opacity-90 text-sm md:text-base flex items-center gap-2">{user.email}</p></div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex bg-indigo-900/30 p-1.5 rounded-2xl backdrop-blur-sm border border-white/10">
                                        <button onClick={() => setActiveTab('overview')} className={`px-5 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${activeTab === 'overview' ? 'bg-white text-indigo-600 shadow-lg' : 'text-indigo-100 hover:bg-white/10'}`}><BarChart3 size={18} /> Dash</button>
                                        <button onClick={() => setActiveTab('plans')} className={`px-5 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${activeTab === 'plans' ? 'bg-white text-indigo-600 shadow-lg' : 'text-indigo-100 hover:bg-white/10'}`}><Package size={18} /> Planos</button>
                                        <button onClick={() => setActiveTab('management')} className={`px-5 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${activeTab === 'management' ? 'bg-white text-indigo-600 shadow-lg' : 'text-indigo-100 hover:bg-white/10'}`}><Users size={18} /> Clientes</button>
                                        <button onClick={() => setActiveTab('script')} className={`px-5 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${activeTab === 'script' ? 'bg-white text-indigo-600 shadow-lg' : 'text-indigo-100 hover:bg-white/10'}`}><Settings size={18} /></button>
                                    </div>
                                    <button onClick={handleLogout} className="bg-red-500/20 hover:bg-red-500 text-white p-3 rounded-xl backdrop-blur-sm border border-white/10 transition-colors"><LogOut size={20} /></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* HEADER MOBILE (SIMPLIFICADO) */}
                    <div className="md:hidden bg-indigo-600 text-white p-4 pb-8 rounded-b-3xl shadow-lg no-print">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-2"><Sparkles size={20} className="text-yellow-300" /><h1 className="font-bold text-lg">Gest√£o SaaS</h1></div>
                            <button onClick={handleLogout}><LogOut size={20} /></button>
                        </div>
                        <p className="text-xs text-indigo-200 mt-1 ml-7">{user.email}</p>
                    </div>

                    <main className="max-w-7xl mx-auto px-4 md:px-6 md:-mt-24 mt-4 relative z-20 pb-24">
                        {/* --- PLANS TAB --- */}
                        {activeTab === 'plans' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 animate-fadeIn">
                                <div className="md:col-span-1">
                                    <div className="bg-white p-5 md:p-6 rounded-2xl shadow-lg border border-slate-100 md:sticky md:top-6">
                                        <h2 className="text-lg md:text-xl font-extrabold mb-4 text-slate-800 flex items-center gap-2 border-b border-slate-100 pb-3"><Package className="text-indigo-600" /> Novo Plano</h2>
                                        <form onSubmit={handleAddPlan} className="space-y-3">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Nome</label><input type="text" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" placeholder="Ex: Site B√°sico" value={newPlan.name} onChange={e => setNewPlan({...newPlan, name: e.target.value})} required /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Valor (R$)</label><input type="number" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" placeholder="0.00" value={newPlan.value} onChange={e => setNewPlan({...newPlan, value: e.target.value})} required /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Descri√ß√£o</label><textarea rows="2" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none resize-none text-sm" placeholder="Detalhes..." value={newPlan.description} onChange={e => setNewPlan({...newPlan, description: e.target.value})} /></div>
                                            <button type="submit" disabled={isSyncing} className="w-full py-3 rounded-xl font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg transition-all flex justify-center items-center gap-2 text-sm">{isSyncing ? '...' : <><Plus size={18} /> Criar</>}</button>
                                        </form>
                                    </div>
                                </div>
                                <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 content-start pb-20">
                                    {plans.length === 0 && <div className="col-span-full text-center py-12 bg-white rounded-2xl shadow-sm border border-dashed border-slate-300"><Package size={40} className="mx-auto mb-3 text-slate-300" /><p className="text-slate-500 text-sm">Sem planos.</p></div>}
                                    {plans.map(plan => (
                                        <div key={plan.id} className="bg-white p-5 rounded-2xl shadow-md border border-slate-100 relative group">
                                            <button onClick={() => handleDeletePlan(plan.id)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={18} /></button>
                                            <h3 className="font-bold text-slate-800 mb-1">{plan.name}</h3>
                                            <p className="text-2xl font-extrabold text-indigo-600 mb-3">{formatCurrency(plan.value)}<span className="text-xs text-slate-400 font-normal">/m√™s</span></p>
                                            <div className="bg-slate-50 p-3 rounded-lg text-xs text-slate-600 mb-3 min-h-[50px]">{plan.description || 'Sem descri√ß√£o.'}</div>
                                            <div className="flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider"><Users size={12} />{clients.filter(c => c.planId === plan.id).length} Assinantes</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* --- MANAGEMENT TAB --- */}
                        {activeTab === 'management' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8 animate-fadeIn">
                                <div className="lg:col-span-1 no-print">
                                    <div className="bg-white p-5 md:p-6 rounded-2xl shadow-lg border border-slate-100 sticky top-6">
                                        <h2 className="text-lg md:text-xl font-extrabold mb-4 text-slate-800 flex items-center gap-2 border-b border-slate-100 pb-3"><UserPlus className="text-indigo-600" /> Novo Assinante</h2>
                                        <ClientForm data={newClient} setData={setNewClient} onSubmit={handleAddClient} />
                                    </div>
                                </div>
                                <div className="lg:col-span-2 pb-20">
                                    <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden flex flex-col h-full" id="print-area">
                                        <div className="p-4 md:p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50 no-print">
                                            <div className="flex items-center gap-3 w-full md:w-auto"><div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><Users size={20} /></div><h2 className="text-lg font-bold text-slate-700">Assinantes</h2></div>
                                            <div className="flex gap-2 w-full md:w-auto overflow-x-auto">
                                                <button onClick={handleSyncFromSheets} disabled={isSyncing} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm whitespace-nowrap"><DownloadCloud size={14} /> Sync</button>
                                                <button onClick={checkRenewals} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm whitespace-nowrap"><RefreshCw size={14} /> Renovar</button>
                                                <button onClick={handlePrintReport} className="bg-white border p-2 rounded-lg text-slate-600 hidden md:block"><Printer size={16} /></button>
                                            </div>
                                        </div>
                                        <div className="p-3 md:p-4 bg-white border-b border-slate-100 flex flex-col sm:flex-row gap-2 no-print">
                                            <div className="relative group flex-1"><Search className="absolute left-3 top-2.5 text-slate-400" size={16} /><input type="text" placeholder="Buscar..." className="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                            <select className="p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}><option value="Todos">Todos</option><option value="Pendente">Pendente</option><option value="Pago">Pago</option><option value="Em atraso">Atrasado</option></select>
                                        </div>
                                        <div className="overflow-x-auto flex-1">
                                            <table className="w-full text-left border-collapse">
                                                <thead className="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-bold">
                                                    <tr><SortableHeader label="Cliente" sortKey="name" /><SortableHeader label="Plano" sortKey="service" /><SortableHeader label="Valor" sortKey="value" /><th className="p-4 text-right no-print">A√ß√£o</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 text-sm">
                                                    {processedClients.map((client) => {
                                                        const overdue = isOverdue(client);
                                                        return (
                                                            <tr key={client.id} className="hover:bg-indigo-50/40 transition-colors group">
                                                                <td className="p-4 pl-4 md:pl-6"><div className="font-bold text-slate-700">{client.name}</div><div className="text-[10px] text-slate-400">{new Date(client.date).toLocaleDateString('pt-BR').slice(0,5)}</div></td>
                                                                <td className="p-4 text-slate-600"><span className={`px-2 py-0.5 rounded text-[10px] font-medium ${client.planId ? 'bg-indigo-50 text-indigo-700' : 'bg-slate-100'}`}>{client.service?.slice(0, 15) || 'Personalizado'}</span></td>
                                                                <td className="p-4 font-bold text-slate-700">{formatCurrency(client.value)}
                                                                    <div className={`mt-1 text-[10px] font-bold flex items-center gap-1 ${client.status === 'Pago' ? 'text-green-600' : client.status === 'Em atraso' ? 'text-red-500' : 'text-yellow-600'}`}>
                                                                        {client.status === 'Pago' ? 'Pago' : client.status === 'Em atraso' ? 'Atraso' : 'Pend.'} {overdue && client.status === 'Pendente' && <AlertCircle size={10} />}
                                                                    </div>
                                                                </td>
                                                                <td className="p-4 pr-4 md:pr-6 text-right flex justify-end gap-1 md:gap-2 no-print">
                                                                    <button onClick={() => setReceiptClient(client)} className="p-1.5 md:p-2 text-slate-300 hover:text-green-500 rounded-lg hover:bg-green-50"><FileCheck size={16} /></button>
                                                                    <button onClick={() => setHistoryClient(client)} className="p-1.5 md:p-2 text-slate-400 hover:text-indigo-600 rounded-lg hover:bg-indigo-50"><History size={16} /></button>
                                                                    <button onClick={() => setEditingClient(client)} className="p-1.5 md:p-2 text-slate-300 hover:text-indigo-500 rounded-lg hover:bg-indigo-50"><Edit size={16} /></button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- OVERVIEW TAB --- */}
                        {activeTab === 'overview' && (
                            <div className="space-y-6 md:space-y-8 animate-fadeIn pb-20 no-print">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                    <div className="bg-white p-5 rounded-2xl shadow-lg border border-slate-100"><div className="flex justify-between items-start mb-2"><div><p className="text-slate-500 text-xs font-bold uppercase tracking-wider">MRR (Mensal)</p><h3 className="text-2xl md:text-3xl font-extrabold text-indigo-600 mt-1">{formatCurrency(clients.filter(c => c.type === 'Mensal').reduce((a, b) => a + Number(b.value), 0))}</h3></div><div className="bg-indigo-50 p-2 rounded-xl text-indigo-600"><TrendingUp size={20} /></div></div></div>
                                    <div className="bg-white p-5 rounded-2xl shadow-lg border border-slate-100"><div className="flex justify-between items-start mb-2"><div><p className="text-slate-500 text-xs font-bold uppercase tracking-wider">Atrasados</p><h3 className="text-2xl md:text-3xl font-extrabold text-red-500 mt-1">{formatCurrency(clients.filter(c => c.status === 'Em atraso').reduce((a, b) => a + Number(b.value), 0))}</h3></div><div className="bg-red-50 p-2 rounded-xl text-red-500"><AlertTriangle size={20} /></div></div></div>
                                    <div className="bg-white p-5 rounded-2xl shadow-lg border border-slate-100"><div className="flex justify-between items-start mb-2"><div><p className="text-slate-500 text-xs font-bold uppercase tracking-wider">Assinantes</p><h3 className="text-2xl md:text-3xl font-extrabold text-slate-800 mt-1">{clients.length}</h3></div><div className="bg-slate-100 p-2 rounded-xl text-slate-600"><Users size={20} /></div></div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                                    <div className="bg-white p-5 md:p-6 rounded-2xl shadow-lg border border-slate-100">
                                        <h3 className="font-bold text-slate-800 mb-4 md:mb-6 text-sm md:text-base">Distribui√ß√£o por Planos</h3>
                                        <div className="h-56 md:h-64 w-full">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <PieChart>
                                                    <Pie data={planDistribution} cx="50%" cy="50%" innerRadius={60} outerRadius={80} fill="#8884d8" paddingAngle={5} dataKey="value">
                                                        {planDistribution.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}
                                                    </Pie>
                                                    <RechartsTooltip />
                                                    <Legend />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'script' && <AppsScriptView />}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
